<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creer un flipbook - OpenFlip</title>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Animation du spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Animation pulse pour la barre de progression */
        @keyframes pulse-bar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-bar {
            animation: pulse-bar 1.5s ease-in-out infinite;
        }

        /* Animation d'entree */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased min-h-screen">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <a href="/" class="flex items-center gap-2 group">
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-600 to-indigo-500 rounded-lg flex items-center justify-center shadow-sm">
                        <i class="fa-solid fa-book-open text-white text-sm"></i>
                    </div>
                    <span class="font-semibold text-lg">
                        <span class="text-indigo-600">Open</span><span class="text-slate-700">Flip</span>
                    </span>
                </a>

                <!-- Navigation -->
                <div class="hidden md:flex items-center gap-8">
                    <a href="/" class="text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors">Accueil</a>
                    <a href="/gallery" class="text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors">Galerie</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-2xl mx-auto px-4 sm:px-6 py-12" x-data="uploadApp()">

        <!-- Back Button -->
        <a href="/" class="inline-flex items-center gap-2 text-sm text-slate-500 hover:text-indigo-600 transition-colors mb-8">
            <i class="fa-solid fa-arrow-left"></i>
            Retour a l'accueil
        </a>

        <!-- Header -->
        <div class="text-center mb-10">
            <div class="w-16 h-16 mx-auto bg-indigo-100 rounded-2xl flex items-center justify-center mb-4">
                <i class="fa-solid fa-cloud-arrow-up text-indigo-600 text-2xl"></i>
            </div>
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Creer un flipbook</h1>
            <p class="mt-2 text-slate-500">Uploadez votre PDF et transformez-le en flipbook interactif</p>
        </div>

        <!-- ================================================================== -->
        <!-- ETAPE 1: Zone de Drop -->
        <!-- ================================================================== -->
        <div x-show="currentStep === 'select'" x-transition:enter="animate-fadeIn" class="space-y-6">

            <!-- Dropzone -->
            <div
                id="dropzone"
                class="relative border-2 border-dashed rounded-2xl p-10 sm:p-16 text-center cursor-pointer transition-all duration-300"
                :class="isDragging
                    ? 'border-indigo-500 bg-indigo-50 scale-[1.02]'
                    : 'border-slate-300 hover:border-indigo-400 hover:bg-slate-50'"
                @click="$refs.fileInput.click()"
                @dragover.prevent="isDragging = true"
                @dragenter.prevent="isDragging = true"
                @dragleave.prevent="isDragging = false"
                @drop.prevent="handleDrop($event)"
            >
                <input
                    type="file"
                    x-ref="fileInput"
                    accept=".pdf,application/pdf"
                    class="hidden"
                    @change="handleFileSelect($event)"
                >

                <!-- Icon -->
                <div class="w-20 h-20 mx-auto bg-gradient-to-br from-indigo-100 to-indigo-50 rounded-2xl flex items-center justify-center mb-6 transition-transform duration-300"
                     :class="isDragging ? 'scale-110' : ''">
                    <i class="fa-solid fa-file-pdf text-indigo-600 text-3xl"></i>
                </div>

                <!-- Text -->
                <p class="text-slate-900 font-semibold text-lg mb-2">
                    <span x-show="!isDragging">Deposez votre PDF ici</span>
                    <span x-show="isDragging" class="text-indigo-600">Lachez pour uploader</span>
                </p>
                <p class="text-slate-500 text-sm mb-6">ou cliquez pour parcourir vos fichiers</p>

                <!-- Button -->
                <span class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white text-sm font-medium rounded-lg hover:from-indigo-700 hover:to-indigo-600 transition-all shadow-sm">
                    <i class="fa-solid fa-folder-open"></i>
                    Parcourir
                </span>

                <!-- Constraints -->
                <p class="mt-6 text-xs text-slate-400">
                    <i class="fa-solid fa-info-circle mr-1"></i>
                    PDF uniquement - Maximum 50 Mo
                </p>
            </div>
        </div>

        <!-- ================================================================== -->
        <!-- ETAPE 2: Configuration -->
        <!-- ================================================================== -->
        <div x-show="currentStep === 'configure'" x-transition:enter="animate-fadeIn" class="space-y-6">

            <!-- Selected File Card -->
            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                <div class="flex items-center gap-4">
                    <!-- Icon -->
                    <div class="w-14 h-14 bg-indigo-100 rounded-xl flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-file-pdf text-indigo-600 text-xl"></i>
                    </div>

                    <!-- File Info -->
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-slate-900 truncate" x-text="fileName"></p>
                        <p class="text-sm text-slate-500" x-text="fileSize"></p>
                    </div>

                    <!-- Change Button -->
                    <button
                        @click="resetToSelect()"
                        class="px-3 py-1.5 text-sm text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    >
                        <i class="fa-solid fa-pen mr-1"></i>
                        Changer
                    </button>
                </div>
            </div>

            <!-- Title Input -->
            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                <label for="titleInput" class="block text-sm font-medium text-slate-700 mb-3">
                    <i class="fa-solid fa-heading mr-2 text-slate-400"></i>
                    Titre du flipbook
                </label>
                <input
                    type="text"
                    id="titleInput"
                    x-model="title"
                    placeholder="Entrez un titre pour votre flipbook"
                    class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                >
            </div>

            <!-- Convert Button -->
            <button
                @click="startUpload()"
                class="w-full py-4 px-6 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-semibold rounded-xl hover:from-indigo-700 hover:to-indigo-600 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-3"
            >
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                Creer le flipbook
            </button>
        </div>

        <!-- ================================================================== -->
        <!-- ETAPE 3: Upload & Conversion Progress -->
        <!-- ================================================================== -->
        <div x-show="currentStep === 'uploading'" x-transition:enter="animate-fadeIn" class="space-y-6">

            <!-- Progress Card -->
            <div class="bg-white border border-slate-200 rounded-xl p-8 shadow-sm text-center">

                <!-- Spinner ou Checkmark -->
                <div class="w-20 h-20 mx-auto mb-6 relative">
                    <!-- Spinner de chargement -->
                    <div x-show="!isComplete" class="w-full h-full">
                        <svg class="w-full h-full animate-spin" viewBox="0 0 80 80">
                            <circle
                                cx="40" cy="40" r="35"
                                fill="none"
                                stroke="#E0E7FF"
                                stroke-width="6"
                            />
                            <circle
                                cx="40" cy="40" r="35"
                                fill="none"
                                stroke="#4F46E5"
                                stroke-width="6"
                                stroke-linecap="round"
                                :stroke-dasharray="220"
                                :stroke-dashoffset="220 - (220 * progress / 100)"
                                transform="rotate(-90 40 40)"
                            />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-indigo-600" x-text="progress + '%'"></span>
                        </div>
                    </div>

                    <!-- Checkmark de succes -->
                    <div x-show="isComplete" class="w-full h-full bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-check text-green-600 text-3xl"></i>
                    </div>
                </div>

                <!-- Status Text -->
                <h3 class="text-lg font-semibold text-slate-900 mb-2" x-text="statusTitle"></h3>
                <p class="text-slate-500 text-sm" x-text="statusMessage"></p>

                <!-- Progress Bar (Linear) -->
                <div class="mt-6 h-2 bg-slate-100 rounded-full overflow-hidden">
                    <div
                        class="h-full bg-gradient-to-r from-indigo-600 to-indigo-500 transition-all duration-300"
                        :class="isConverting ? 'animate-pulse-bar' : ''"
                        :style="'width: ' + progress + '%'"
                    ></div>
                </div>

                <!-- Phase indicator -->
                <div class="mt-4 flex items-center justify-center gap-2 text-xs text-slate-400">
                    <span :class="progress > 0 ? 'text-indigo-600' : ''">
                        <i class="fa-solid fa-circle" :class="progress > 0 ? '' : 'opacity-30'"></i>
                        Envoi
                    </span>
                    <span class="text-slate-300">—</span>
                    <span :class="isConverting ? 'text-indigo-600' : ''">
                        <i class="fa-solid fa-circle" :class="isConverting ? '' : 'opacity-30'"></i>
                        Conversion
                    </span>
                    <span class="text-slate-300">—</span>
                    <span :class="isComplete ? 'text-green-600' : ''">
                        <i class="fa-solid fa-circle" :class="isComplete ? '' : 'opacity-30'"></i>
                        Termine
                    </span>
                </div>
            </div>

            <!-- Cancel Button (only during upload, not conversion) -->
            <button
                x-show="!isConverting && !isComplete"
                @click="cancelUpload()"
                class="w-full py-3 px-6 bg-slate-100 text-slate-600 font-medium rounded-xl hover:bg-slate-200 transition-colors"
            >
                Annuler
            </button>
        </div>

        <!-- ================================================================== -->
        <!-- ERROR ALERT -->
        <!-- ================================================================== -->
        <div
            x-show="errorMessage"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            class="mt-6 p-4 bg-red-50 border border-red-200 rounded-xl"
        >
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-exclamation-triangle text-red-600"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-red-800">Erreur</h4>
                    <p class="text-sm text-red-700 mt-1" x-text="errorMessage"></p>
                </div>
                <button @click="errorMessage = ''" class="text-red-400 hover:text-red-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-200 mt-auto">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p class="text-center text-sm text-slate-400">
                <span class="font-medium text-indigo-600">Open</span><span class="font-medium text-slate-600">Flip</span>
                - Alternative Open Source a Heyzine
            </p>
        </div>
    </footer>

    <!-- ================================================================== -->
    <!-- ALPINE.JS APPLICATION -->
    <!-- ================================================================== -->
    <script>
        function uploadApp() {
            return {
                // State
                currentStep: 'select', // 'select', 'configure', 'uploading'
                selectedFile: null,
                fileName: '',
                fileSize: '',
                title: '',

                // Upload state
                progress: 0,
                isConverting: false,
                isComplete: false,
                statusTitle: 'Envoi en cours...',
                statusMessage: 'Transfert du fichier vers le serveur',

                // Error
                errorMessage: '',

                // Drag state
                isDragging: false,

                // XHR reference for cancellation
                xhr: null,

                // ============================================================
                // FILE SELECTION
                // ============================================================

                handleDrop(event) {
                    this.isDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file) this.validateAndSelectFile(file);
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) this.validateAndSelectFile(file);
                },

                validateAndSelectFile(file) {
                    // Reset error
                    this.errorMessage = '';

                    // Check file type
                    if (!file.name.toLowerCase().endsWith('.pdf') && file.type !== 'application/pdf') {
                        this.errorMessage = 'Seuls les fichiers PDF sont acceptes. Veuillez selectionner un fichier .pdf';
                        return;
                    }

                    // Check file size (50 MB max)
                    const maxSize = 50 * 1024 * 1024;
                    if (file.size > maxSize) {
                        this.errorMessage = `Le fichier est trop volumineux (${this.formatFileSize(file.size)}). La taille maximum est de 50 Mo.`;
                        return;
                    }

                    // Store file
                    this.selectedFile = file;
                    this.fileName = file.name;
                    this.fileSize = this.formatFileSize(file.size);

                    // Pre-fill title
                    this.title = file.name.replace(/\.pdf$/i, '').replace(/_/g, ' ');

                    // Go to configure step
                    this.currentStep = 'configure';
                },

                formatFileSize(bytes) {
                    if (bytes < 1024) return bytes + ' octets';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' Ko';
                    return (bytes / (1024 * 1024)).toFixed(2) + ' Mo';
                },

                resetToSelect() {
                    this.currentStep = 'select';
                    this.selectedFile = null;
                    this.fileName = '';
                    this.fileSize = '';
                    this.title = '';
                    this.errorMessage = '';

                    // Reset file input
                    if (this.$refs.fileInput) {
                        this.$refs.fileInput.value = '';
                    }
                },

                // ============================================================
                // UPLOAD LOGIC (REAL XHR)
                // ============================================================

                startUpload() {
                    if (!this.selectedFile) return;

                    // Reset states
                    this.errorMessage = '';
                    this.progress = 0;
                    this.isConverting = false;
                    this.isComplete = false;
                    this.statusTitle = 'Envoi en cours...';
                    this.statusMessage = 'Transfert du fichier vers le serveur';

                    // Switch to uploading view
                    this.currentStep = 'uploading';

                    // Create FormData
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    // Add title if provided
                    const customTitle = this.title.trim();
                    if (customTitle) {
                        formData.append('title', customTitle);
                    }

                    // Create XMLHttpRequest
                    this.xhr = new XMLHttpRequest();

                    // --------------------------------------------------------
                    // UPLOAD PROGRESS (Real bytes sent)
                    // --------------------------------------------------------
                    this.xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            this.progress = percent;

                            // Update status based on progress
                            if (percent < 100) {
                                const sent = this.formatFileSize(e.loaded);
                                const total = this.formatFileSize(e.total);
                                this.statusTitle = 'Envoi en cours...';
                                this.statusMessage = `${sent} / ${total} transferes`;
                            }
                        }
                    });

                    // --------------------------------------------------------
                    // UPLOAD COMPLETE - WAITING FOR SERVER (CONVERSION)
                    // --------------------------------------------------------
                    this.xhr.upload.addEventListener('load', () => {
                        this.progress = 90; // Rester à 90% jusqu'à la fin du serveur
                        this.isConverting = true;
                        this.statusTitle = 'Conversion en cours...';
                        this.statusMessage = 'Le serveur traite votre PDF. Cela peut prendre quelques instants.';

                        // Progression simulée pendant la conversion (90% -> 99%)
                        let simulatedProgress = 90;
                        const progressInterval = setInterval(() => {
                            if (this.isConverting && simulatedProgress < 99) {
                                simulatedProgress += Math.random() * 3; // Augmenter de 0-3% aléatoirement
                                this.progress = Math.min(Math.floor(simulatedProgress), 99);
                            } else {
                                clearInterval(progressInterval);
                            }
                        }, 800); // Mettre à jour tous les 800ms
                    });

                    // --------------------------------------------------------
                    // SERVER RESPONSE
                    // --------------------------------------------------------
                    this.xhr.addEventListener('load', () => {
                        this.isConverting = false;
                        this.progress = 100; // Marquer comme 100% une fois la réponse reçue

                        if (this.xhr.status === 200) {
                            // SUCCESS
                            try {
                                const response = JSON.parse(this.xhr.responseText);

                                if (response.id) {
                                    this.isComplete = true;
                                    this.statusTitle = 'Flipbook cree !';
                                    this.statusMessage = 'Redirection vers l\'editeur...';

                                    // Redirect to editor
                                    window.location.href = '/editor/' + response.id;
                                } else {
                                    this.handleError('Reponse invalide du serveur');
                                }
                            } catch (e) {
                                this.handleError('Erreur lors de l\'analyse de la reponse');
                            }
                        } else {
                            // ERROR (400, 500, etc.)
                            let errorMsg = 'Une erreur est survenue lors de l\'upload';

                            try {
                                const errorResponse = JSON.parse(this.xhr.responseText);
                                errorMsg = errorResponse.detail || errorResponse.message || errorMsg;
                            } catch (e) {
                                // Response is not JSON
                                if (this.xhr.status === 413) {
                                    errorMsg = 'Le fichier est trop volumineux pour le serveur';
                                } else if (this.xhr.status === 415) {
                                    errorMsg = 'Format de fichier non supporte';
                                } else if (this.xhr.status === 500) {
                                    errorMsg = 'Erreur interne du serveur. Veuillez reessayer.';
                                } else if (this.xhr.status === 503) {
                                    errorMsg = 'Service temporairement indisponible. Veuillez reessayer.';
                                }
                            }

                            this.handleError(errorMsg);
                        }
                    });

                    // --------------------------------------------------------
                    // NETWORK ERROR
                    // --------------------------------------------------------
                    this.xhr.addEventListener('error', () => {
                        this.handleError('Erreur de connexion. Verifiez votre connexion internet et reessayez.');
                    });

                    // --------------------------------------------------------
                    // TIMEOUT
                    // --------------------------------------------------------
                    this.xhr.addEventListener('timeout', () => {
                        this.handleError('La requete a expire. Le fichier est peut-etre trop volumineux ou le serveur est surcharge.');
                    });

                    // --------------------------------------------------------
                    // ABORTED
                    // --------------------------------------------------------
                    this.xhr.addEventListener('abort', () => {
                        this.currentStep = 'configure';
                        this.progress = 0;
                    });

                    // --------------------------------------------------------
                    // SEND REQUEST
                    // --------------------------------------------------------
                    this.xhr.open('POST', '/api/upload');
                    this.xhr.timeout = 300000; // 5 minutes timeout
                    this.xhr.send(formData);
                },

                // ============================================================
                // ERROR HANDLING
                // ============================================================

                handleError(message) {
                    this.errorMessage = message;
                    this.currentStep = 'configure';
                    this.progress = 0;
                    this.isConverting = false;
                    this.isComplete = false;
                    this.xhr = null;
                },

                // ============================================================
                // CANCEL UPLOAD
                // ============================================================

                cancelUpload() {
                    if (this.xhr) {
                        this.xhr.abort();
                        this.xhr = null;
                    }
                }
            };
        }
    </script>

</body>
</html>
