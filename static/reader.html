<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur - OpenFlip</title>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Turn.js Library - jQuery first, then Turn.js -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/blasten/turn.js@master/turn.min.js"></script>

    <!-- Swiper.js Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-image: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', system-ui, sans-serif;
            background: #0f172a;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            z-index: -1;  /* Behind everything */
            pointer-events: none;
        }

        /* ================================================================ */
        /* HEADER                                                          */
        /* ================================================================ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4f46e5 0%, #4f46e5 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .header-title {
            color: #cbd5e1;
            font-size: 14px;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }

        /* ================================================================ */
        /* MAIN CONTAINER                                                  */
        /* ================================================================ */
        .container {
            position: absolute;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            overflow: hidden;
            background: transparent;
            z-index: 10;  /* Above background */
        }

        /* Reader Viewport */
        #reader-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Turn.js Container */
        .turn-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        #book {
            width: auto;
            height: auto;
            background: white;
            box-shadow:
                0 50px 100px rgba(0, 0, 0, 0.3),
                0 25px 50px rgba(0, 0, 0, 0.2);
            z-index: 20;
            position: relative;
            aspect-ratio: auto;
        }

        #book .my-page {
            width: 100%;
            height: 100%;
            display: block;
        }

        #book .my-page img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        #book .my-page {
            background: white;
            display: none;
            position: relative;
            overflow: hidden;
        }

        #book .my-page img {
            width: 100%;
            height: 100%;
            object-fit: fill;
            user-select: none;
        }

        /* Swiper Container */
        .swiper-container {
            width: 100%;
            height: 100%;
        }

        .swiper {
            width: 100%;
            height: 100%;
        }

        .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }

        .swiper-slide .page-content {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swiper-slide img {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            user-select: none;
        }

        /* Swiper Navigation */
        .swiper-button-next,
        .swiper-button-prev {
            color: white;
            background: rgba(79, 70, 229, 0.8);
            width: 44px;
            height: 44px;
            border-radius: 50%;
        }

        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 18px;
        }

        .swiper-button-next:hover,
        .swiper-button-prev:hover {
            background: rgba(79, 70, 229, 1);
        }

        .swiper-pagination-bullet {
            background: white;
            opacity: 0.5;
        }

        .swiper-pagination-bullet-active {
            background: #4f46e5;
            opacity: 1;
        }

        /* Coverflow specific */
        .swiper-coverflow .swiper-slide {
            width: 60%;
        }

        /* Cards specific */
        .swiper-cards .swiper-slide {
            width: 80%;
        }

        /* Cube specific */
        .swiper-cube {
            overflow: visible;
        }

        /* ================================================================ */
        /* LOADING & ERROR STATES                                          */
        /* ================================================================ */
        #loading {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #e2e8f0;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        #loading p {
            margin-top: 16px;
            color: #64748b;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #error {
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            text-align: center;
            padding: 20px;
        }

        #error.show { display: flex; }
        #error i { color: #ef4444; font-size: 64px; margin-bottom: 16px; }
        #error h2 { font-size: 24px; color: #1e293b; margin-bottom: 8px; }
        #error p { color: #64748b; margin-bottom: 24px; }
        #error a {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
        }

        /* ================================================================ */
        /* CONTROL BAR                                                     */
        /* ================================================================ */
        .control-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }

        .control-btn {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .control-btn:hover:not(:disabled) {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .control-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* ================================================================ */
        /* MODE DROPDOWN                                                   */
        /* ================================================================ */
        .mode-dropdown {
            position: relative;
        }

        .mode-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .mode-dropdown-btn:hover {
            background: rgba(79, 70, 229, 0.5);
            border-color: #4f46e5;
        }

        .mode-dropdown-btn i.mode-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        .mode-dropdown-btn i.chevron {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .mode-dropdown.open .mode-dropdown-btn i.chevron {
            transform: rotate(180deg);
        }

        .mode-dropdown-menu {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 8px;
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }

        .mode-dropdown.open .mode-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s;
        }

        .mode-option:hover {
            background: rgba(79, 70, 229, 0.3);
            color: white;
        }

        .mode-option.active {
            background: #4f46e5;
            color: white;
        }

        .mode-option i {
            width: 18px;
            text-align: center;
            font-size: 14px;
        }

        .mode-option-label {
            flex: 1;
        }

        .mode-option .check {
            opacity: 0;
            font-size: 12px;
        }

        .mode-option.active .check {
            opacity: 1;
        }

        /* ================================================================ */
        /* PROGRESS BAR                                                    */
        /* ================================================================ */
        .progress-container {
            width: 120px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Zoom Display */
        .zoom-display {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            min-width: 40px;
            text-align: center;
        }

        /* ================================================================ */
        /* WIDGETS                                                         */
        /* ================================================================ */
        .widgets-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .widget-overlay {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .widget-overlay.widget-link {
            border: 2px solid transparent;
            border-radius: 4px;
        }

        .widget-overlay.widget-link:hover {
            border-color: rgba(79, 70, 229, 0.6);
            background: rgba(79, 70, 229, 0.1);
        }

        .widget-overlay.widget-video,
        .widget-overlay.widget-audio {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .widget-overlay.widget-video:hover,
        .widget-overlay.widget-audio:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        .widget-overlay .widget-icon {
            color: white;
            font-size: 24px;
            opacity: 0.8;
        }

        .widget-overlay:hover .widget-icon {
            opacity: 1;
        }

        .widget-overlay.widget-hotspot {
            border: 2px dashed rgba(255, 193, 7, 0.6);
            border-radius: 4px;
        }

        .widget-overlay.widget-hotspot:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        /* ================================================================ */
        /* RESPONSIVE                                                      */
        /* ================================================================ */
        @media (max-width: 768px) {
            .header-title { display: none; }

            .control-bar {
                flex-wrap: wrap;
                max-width: calc(100vw - 32px);
                padding: 8px 12px;
                gap: 8px;
            }

            .control-btn {
                width: 34px;
                height: 34px;
                font-size: 12px;
            }

            .control-divider { display: none; }

            .mode-dropdown-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .progress-container { width: 80px; }
        }

        @media (max-width: 480px) {
            .control-bar {
                bottom: 12px;
                padding: 6px 10px;
                gap: 6px;
            }

            .control-btn {
                width: 32px;
                height: 32px;
            }

            .zoom-display { display: none; }
            .progress-container { width: 60px; }
        }

        /* ================================================================ */
        /* FULLSCREEN                                                      */
        /* ================================================================ */
        body.fullscreen {
            background: #000;
        }

        body.fullscreen .header {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.fullscreen .control-bar {
            background: rgba(0, 0, 0, 0.7);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="back-btn" id="backBtn" title="Retour">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <a href="/" class="header-logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-book-open"></i>
                </div>
                <span><span style="color: #4f46e5;">Open</span><span>Flip</span></span>
            </a>
        </div>
        <div class="header-title" id="docTitle"></div>
    </header>

    <!-- Loading -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Chargement du flipbook...</p>
    </div>

    <!-- Main Container -->
    <div class="container" id="main-container">
        <div id="reader-viewport"></div>
    </div>

    <!-- Control Bar -->
    <div class="control-bar">
        <!-- Mode Dropdown -->
        <div class="mode-dropdown" id="modeDropdown">
            <button class="mode-dropdown-btn" id="modeDropdownBtn">
                <i class="fa-solid fa-book-open mode-icon" id="currentModeIcon"></i>
                <span id="currentModeLabel">Standard</span>
                <i class="fa-solid fa-chevron-up chevron"></i>
            </button>
            <div class="mode-dropdown-menu" id="modeDropdownMenu">
                <div class="mode-option active" data-mode="standard">
                    <i class="fa-solid fa-book-open"></i>
                    <span class="mode-option-label">Standard</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="coverflow">
                    <i class="fa-solid fa-layer-group"></i>
                    <span class="mode-option-label">Coverflow</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="cards">
                    <i class="fa-solid fa-clone"></i>
                    <span class="mode-option-label">Cartes</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="cube">
                    <i class="fa-solid fa-cube"></i>
                    <span class="mode-option-label">Cube</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="fade">
                    <i class="fa-solid fa-images"></i>
                    <span class="mode-option-label">Slide / Fondu</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
            </div>
        </div>

        <div class="control-divider"></div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="control-divider"></div>

        <button class="control-btn" id="zoomOutBtn" title="Zoom arrière (-)">
            <i class="fa-solid fa-minus"></i>
        </button>
        <span class="zoom-display" id="zoomLevel">100%</span>
        <button class="control-btn" id="zoomInBtn" title="Zoom avant (+)">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div class="control-divider"></div>

        <button class="control-btn" id="soundBtn" title="Son (S)">
            <i class="fa-solid fa-volume-high"></i>
        </button>

        <div class="control-divider"></div>

        <button class="control-btn" id="fullscreenBtn" title="Plein écran (F)">
            <i class="fa-solid fa-expand"></i>
        </button>
    </div>

    <!-- Error -->
    <div id="error">
        <i class="fa-solid fa-circle-exclamation"></i>
        <h2>Document introuvable</h2>
        <p>Ce document n'existe pas ou a été supprimé.</p>
        <a href="/upload">Créer un flipbook</a>
    </div>

    <script>
    // ========================================================================
    // READER MANAGER CLASS - Engine Swap Architecture
    // ========================================================================
    class ReaderManager {
        constructor() {
            this.engine = null;          // Current engine instance (PageFlip or Swiper)
            this.engineType = null;      // 'pageflip' or 'swiper'
            this.currentMode = 'standard';
            this.currentPage = 0;
            this.totalPages = 0;
            this.docId = null;
            this.pagesData = [];
            this.imageWidth = 595;
            this.imageHeight = 842;

            // Zoom
            this.zoomLevels = [0.5, 0.75, 1, 1.25, 1.5, 2];
            this.zoomIndex = 2;
            this.currentZoom = 1;

            // Audio - Multiple sound variants for variety
            this.currentAudio = null;
            this.flipSounds = [];  // Array of 4 pre-loaded sounds
            this.isMuted = false;
            this.audioContext = null;
            this.audioInitialized = false;

            // Mode configurations
            this.modes = {
                standard: { engine: 'pageflip', icon: 'fa-book-open', label: 'Standard' },
                coverflow: { engine: 'swiper', effect: 'coverflow', icon: 'fa-layer-group', label: 'Coverflow' },
                cards: { engine: 'swiper', effect: 'cards', icon: 'fa-clone', label: 'Cartes' },
                cube: { engine: 'swiper', effect: 'cube', icon: 'fa-cube', label: 'Cube' },
                fade: { engine: 'swiper', effect: 'fade', icon: 'fa-images', label: 'Slide / Fondu' }
            };

            // Swiper effect configurations
            this.swiperEffects = {
                coverflow: {
                    effect: 'coverflow',
                    grabCursor: true,
                    centeredSlides: true,
                    slidesPerView: 'auto',
                    coverflowEffect: {
                        rotate: 50,
                        stretch: 0,
                        depth: 100,
                        modifier: 1,
                        slideShadows: true
                    }
                },
                cards: {
                    effect: 'cards',
                    grabCursor: true,
                    cardsEffect: {
                        slideShadows: true,
                        perSlideOffset: 8,
                        perSlideRotate: 2
                    }
                },
                cube: {
                    effect: 'cube',
                    grabCursor: true,
                    cubeEffect: {
                        shadow: true,
                        slideShadows: true,
                        shadowOffset: 20,
                        shadowScale: 0.94
                    }
                },
                fade: {
                    effect: 'fade',
                    fadeEffect: {
                        crossFade: true
                    }
                }
            };
        }

        // ====================================================================
        // INITIALIZATION
        // ====================================================================
        async init() {
            try {
                // Get doc ID from URL (remove query params)
                const pathParts = window.location.pathname.split('/').filter(p => p);
                let docId = pathParts[pathParts.length - 1];
                // Remove query parameters if present
                docId = docId.split('?')[0];
                this.docId = docId;

                if (!this.docId) throw new Error('No document ID');

                console.log(`Loading document: ${this.docId}`);

                // Try to get preview data from localStorage first
                let doc = null;
                try {
                    const previewKey = `preview_${this.docId}`;
                    const storedData = localStorage.getItem(previewKey);
                    if (storedData) {
                        doc = JSON.parse(storedData);
                        console.log('✓ Preview data loaded from localStorage');
                        // Clean up localStorage
                        localStorage.removeItem(previewKey);
                    }
                } catch (e) {
                    console.warn('Failed to load preview data from localStorage:', e);
                }

                // If no preview data, fetch from API
                if (!doc) {
                    console.log('Fetching data from API...');
                    const res = await fetch(`/api/reader/${this.docId}`);
                    if (!res.ok) throw new Error(`Document not found (${res.status})`);
                    doc = await res.json();
                    console.log('✓ Data loaded from API');
                }

                this.totalPages = doc.page_count;
                this.pagesData = doc.pages || [];
                this.styleConfig = doc.style || {};
                this.isPreviewMode = !!window.opener;

                document.title = `${doc.title} - OpenFlip`;
                document.getElementById('docTitle').textContent = doc.title;

                // Get image dimensions from first page
                await this.loadImageDimensions();

                // Initialize with configured mode or standard
                const initialMode = this.styleConfig.viewMode || 'standard';
                
                // Wait for turn.js to be ready if using pageflip mode
                if (initialMode === 'standard') {
                    await new Promise(resolve => {
                        const checkTurn = () => {
                            if (typeof $ !== 'undefined' && $.fn.turn) {
                                resolve();
                            } else {
                                setTimeout(checkTurn, 100);
                            }
                        };
                        checkTurn();
                    });
                }
                
                await this.setMode(initialMode);

                // Show container
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-container').style.display = 'flex';

                // Apply style configuration AFTER UI is built
                this.applyStyleConfig();

                // Setup event listeners
                this.setupEventListeners();
                
                // Initialize audio
                this.initAudio();
                
                this.updateUI();

                console.log('ReaderManager initialized', { mode: initialMode, style: this.styleConfig, isPreviewMode: this.isPreviewMode });

            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.add('show');
            }
        }

        waitForPreviewData() {
            return new Promise((resolve) => {
                console.log('Waiting for preview data from parent window...');
                const timeout = setTimeout(() => {
                    console.log('Preview data timeout - using API fallback');
                    window.removeEventListener('message', handleMessage);
                    resolve(null);
                }, 10000); // 10 second timeout

                const handleMessage = (event) => {
                    if (event.origin !== window.location.origin) {
                        console.warn('Message from different origin:', event.origin);
                        return;
                    }

                    console.log('Message received:', event.data?.type);
                    if (event.data?.type === 'PREVIEW_DATA') {
                        clearTimeout(timeout);
                        window.removeEventListener('message', handleMessage);
                        console.log('✓ Preview data received:', event.data.payload);
                        resolve(event.data.payload);
                    }
                };

                window.addEventListener('message', handleMessage);
            });
        }

        applyStyleConfig() {
            const style = this.styleConfig || {};
            console.log('Applying style config:', style);
            
            const body = document.body;

            // Apply background color
            if (style.backgroundColor) {
                console.log('Applying background color:', style.backgroundColor);
                body.style.setProperty('background-color', style.backgroundColor, 'important');
            } else {
                body.style.setProperty('background-color', '#0f172a', 'important');
            }

            // Apply background image using CSS variable (works with body::before)
            if (style.backgroundImage) {
                console.log('Applying background image:', style.backgroundImage);
                // Store in CSS variable for body::before to use
                document.documentElement.style.setProperty('--bg-image', `url(${style.backgroundImage})`);
            } else {
                document.documentElement.style.setProperty('--bg-image', 'none');
            }

            // Show/hide navigation controls
            const navControls = document.querySelector('.nav-controls');
            if (style.showNavigation === false && navControls) {
                navControls.style.setProperty('display', 'none', 'important');
            } else if (style.showNavigation !== false && navControls) {
                navControls.style.setProperty('display', 'flex', 'important');
            }

            // Show/hide progress bar
            const progressContainer = document.querySelector('.progress-container');
            if (style.showProgressBar === false && progressContainer) {
                progressContainer.style.setProperty('display', 'none', 'important');
            } else if (style.showProgressBar !== false && progressContainer) {
                progressContainer.style.setProperty('display', 'block', 'important');
            }

            // Show/hide zoom controls
            const zoomControls = document.querySelectorAll('#zoomOutBtn, #zoomInBtn, .zoom-display');
            if (style.allowZoom === false) {
                zoomControls.forEach(el => el.style.setProperty('display', 'none', 'important'));
            } else if (style.allowZoom !== false) {
                zoomControls.forEach(el => el.style.setProperty('display', '', 'important'));
            }

            // Show/hide fullscreen button
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (style.allowFullscreen === false && fullscreenBtn) {
                fullscreenBtn.style.setProperty('display', 'none', 'important');
            } else if (style.allowFullscreen !== false && fullscreenBtn) {
                fullscreenBtn.style.setProperty('display', '', 'important');
            }

            // Add logo if configured
            if (style.showLogo && style.logoUrl) {
                console.log('Adding logo:', style.logoUrl);
                this.addLogo(style.logoUrl);
            }
            
            console.log('✓ Style config applied');
        }

        addLogo(logoUrl) {
            const existing = document.getElementById('reader-logo');
            if (existing) existing.remove();

            const logo = document.createElement('img');
            logo.id = 'reader-logo';
            logo.src = logoUrl;
            logo.alt = 'Logo';
            logo.style.cssText = 'position:fixed;top:80px;left:24px;height:40px;width:auto;z-index:50;object-fit:contain;';
            document.body.appendChild(logo);
        }

        async loadImageDimensions() {
            // Use page dimensions from data if available (more reliable)
            if (this.pagesData[0]?.width && this.pagesData[0]?.height) {
                this.imageWidth = this.pagesData[0].width;
                this.imageHeight = this.pagesData[0].height;
                console.log('Using page dimensions from data:', this.imageWidth, 'x', this.imageHeight);
                this.setContainerDimensions();
                return;
            }

            // Fallback: load from image
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    this.imageWidth = img.naturalWidth;
                    this.imageHeight = img.naturalHeight;
                    console.log('Using image dimensions:', this.imageWidth, 'x', this.imageHeight);
                    this.setContainerDimensions();
                    resolve();
                };
                img.onerror = () => {
                    console.warn('Failed to load image dimensions, using defaults');
                    this.setContainerDimensions();
                    resolve();
                };
                img.src = this.pagesData[0].image_url || `/pages/${this.docId}/page_1.webp`;
                setTimeout(() => {
                    this.setContainerDimensions();
                    resolve();
                }, 5000); // Timeout
            });
        }

        setContainerDimensions() {
            // Calculate aspect ratio
            const aspectRatio = this.imageWidth / this.imageHeight;
            
            // Get available space (excluding header and padding)
            const availableHeight = window.innerHeight - 64 - 80; // header + padding
            const availableWidth = window.innerWidth - 40; // horizontal padding
            
            // Calculate max dimensions that fit in viewport
            let containerWidth = availableWidth;
            let containerHeight = containerWidth / aspectRatio;
            
            if (containerHeight > availableHeight) {
                containerHeight = availableHeight;
                containerWidth = containerHeight * aspectRatio;
            }
            
            // Apply dimensions to main container
            const container = document.querySelector('.container');
            if (container) {
                container.style.setProperty('max-width', containerWidth + 'px', 'important');
                container.style.setProperty('width', containerWidth + 'px', 'important');
                container.style.setProperty('height', containerHeight + 'px', 'important');
            }
            
            // Apply to turn-container
            const turnContainer = document.querySelector('.turn-container');
            if (turnContainer) {
                turnContainer.style.setProperty('width', containerWidth + 'px', 'important');
                turnContainer.style.setProperty('height', containerHeight + 'px', 'important');
            }
            
            // Apply to swiper-container
            const swiperContainer = document.querySelector('.swiper-container');
            if (swiperContainer) {
                swiperContainer.style.setProperty('width', containerWidth + 'px', 'important');
                swiperContainer.style.setProperty('height', containerHeight + 'px', 'important');
            }
            
            console.log(`✓ Container dimensions set: ${Math.round(containerWidth)}x${Math.round(containerHeight)}px`);
        }

        // ====================================================================
        // MODE SWITCHING (Engine Swap)
        // ====================================================================
        async setMode(modeName) {
            const modeConfig = this.modes[modeName];
            if (!modeConfig) return;

            // Save current page
            const savedPage = this.currentPage;

            // Destroy current engine
            this.destroyEngine();

            // Clear viewport
            const viewport = document.getElementById('reader-viewport');
            viewport.innerHTML = '';

            // Update mode
            this.currentMode = modeName;
            this.engineType = modeConfig.engine;

            // Build new engine
            if (modeConfig.engine === 'pageflip') {
                await this.buildPageFlip(viewport);
            } else {
                await this.buildSwiper(viewport, modeConfig.effect);
            }

            // Restore page
            this.goToPage(savedPage);

            // Update dropdown UI
            this.updateModeDropdown();
            this.updateUI();

            console.log(`Mode changed to: ${modeName}`);
        }

        destroyEngine() {
            if (!this.engine) return;

            try {
                if (this.engineType === 'pageflip') {
                    this.engine.destroy();
                } else if (this.engineType === 'swiper') {
                    this.engine.destroy(true, true);
                }
            } catch (e) {
                console.warn('Engine destroy error:', e);
            }

            this.engine = null;
        }

        // ====================================================================
        // PAGEFLIP ENGINE
        // ====================================================================
        async buildPageFlip(container) {
            console.log('Building PageFlip with turn.js...');
            console.log('jQuery available:', typeof $ !== 'undefined');
            console.log('Turn available:', typeof $(document).turn !== 'undefined');
            
            // Create structure
            const wrapper = document.createElement('div');
            wrapper.className = 'turn-container';
            wrapper.id = 'turn-wrapper';

            const book = document.createElement('div');
            book.id = 'book';

            // Create pages for turn.js
            for (let i = 0; i < this.totalPages; i++) {
                const pageData = this.pagesData[i] || {};
                const pageNum = i + 1;

                const page = document.createElement('div');
                page.className = 'my-page';

                // Create page content with image
                const pageContent = document.createElement('div');
                pageContent.style.cssText = 'position: relative; width: 100%; height: 100%;';

                const img = document.createElement('img');
                img.src = pageData.image_url || `/pages/${this.docId}/page_${pageNum}.webp`;
                img.alt = `Page ${pageNum}`;
                img.style.cssText = 'width: 100%; height: 100%; object-fit: contain;';
                img.draggable = false;
                pageContent.appendChild(img);

                // Add widgets
                const widgetsContainer = this.createWidgetsContainer(pageData);
                pageContent.appendChild(widgetsContainer);

                page.appendChild(pageContent);
                book.appendChild(page);
            }

            wrapper.appendChild(book);
            container.appendChild(wrapper);

            // Initialize turn.js with error handling
            try {
                console.log('Initializing turn.js...');
                $(book).turn({
                    width: this.imageWidth,
                    height: this.imageHeight,
                    autoCenter: true,
                    acceleration: true,
                    gradients: true,
                    elevation: 50,
                    duration: 600,  // Animation duration in ms (smooth but not slow)
                    when: {
                        turned: (e, page) => {
                            this.currentPage = page - 1;
                            this.playPageFlipSound();
                            this.updateUI();
                        }
                    }
                });

                this.engine = $(book).data('turn');
                console.log('✓ turn.js initialized successfully');
            } catch (error) {
                console.error('turn.js initialization error:', error);
                throw error;
            }

            // Apply container dimensions
            this.setContainerDimensions();
        }

        // ====================================================================
        // SWIPER ENGINE
        // ====================================================================
        async buildSwiper(container, effect) {
            // Create structure
            const swiperContainer = document.createElement('div');
            swiperContainer.className = 'swiper-container';

            const swiper = document.createElement('div');
            swiper.className = 'swiper';
            swiper.id = 'swiper';

            const wrapper = document.createElement('div');
            wrapper.className = 'swiper-wrapper';

            // Create slides
            for (let i = 0; i < this.totalPages; i++) {
                const pageData = this.pagesData[i] || {};
                const pageNum = i + 1;

                const slide = document.createElement('div');
                slide.className = 'swiper-slide';

                const content = document.createElement('div');
                content.className = 'page-content';

                const img = document.createElement('img');
                img.src = pageData.image_url || `/pages/${this.docId}/page_${pageNum}.webp`;
                img.alt = `Page ${pageNum}`;
                img.loading = pageNum <= 3 ? 'eager' : 'lazy';
                img.draggable = false;
                content.appendChild(img);

                // Add widgets
                const widgetsContainer = this.createWidgetsContainer(pageData);
                content.appendChild(widgetsContainer);

                slide.appendChild(content);
                wrapper.appendChild(slide);
            }

            swiper.appendChild(wrapper);

            // Add navigation elements
            const pagination = document.createElement('div');
            pagination.className = 'swiper-pagination';
            swiper.appendChild(pagination);

            const prevBtn = document.createElement('div');
            prevBtn.className = 'swiper-button-prev';
            swiper.appendChild(prevBtn);

            const nextBtn = document.createElement('div');
            nextBtn.className = 'swiper-button-next';
            swiper.appendChild(nextBtn);

            swiperContainer.appendChild(swiper);
            container.appendChild(swiperContainer);

            // Get effect config
            const effectConfig = this.swiperEffects[effect] || {};

            // Base Swiper config
            const swiperConfig = {
                ...effectConfig,
                speed: 800,
                keyboard: { enabled: true },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                    dynamicBullets: true
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev'
                },
                on: {
                    slideChange: () => {
                        this.currentPage = this.engine.activeIndex;
                        this.updateUI();
                    }
                }
            };

            // Special handling for certain effects
            if (effect === 'coverflow') {
                swiperConfig.slidesPerView = 'auto';
                swiperConfig.centeredSlides = true;
            } else if (effect === 'cards' || effect === 'cube') {
                swiperConfig.slidesPerView = 1;
                swiperConfig.centeredSlides = true;
            } else if (effect === 'fade') {
                swiperConfig.slidesPerView = 1;
            }

            // Initialize Swiper
            this.engine = new Swiper('#swiper', swiperConfig);
            
            // Apply container dimensions
            this.setContainerDimensions();
        }

        // ====================================================================
        // WIDGETS
        // ====================================================================
        createWidgetsContainer(pageData) {
            const container = document.createElement('div');
            container.className = 'widgets-container';

            if (!pageData.widgets || pageData.widgets.length === 0) {
                return container;
            }

            pageData.widgets.forEach(widget => {
                const el = this.createWidgetElement(widget, pageData.width, pageData.height);
                if (el) container.appendChild(el);
            });

            return container;
        }

        createWidgetElement(widget, pageWidth, pageHeight) {
            const geo = widget.geometry || {};
            const props = widget.props || {};

            if (!geo.x && !geo.y && !geo.width && !geo.height) return null;

            const el = document.createElement('div');
            el.className = `widget-overlay widget-${widget.type}`;

            const left = (geo.x / pageWidth * 100) || 0;
            const top = (geo.y / pageHeight * 100) || 0;
            const width = (geo.width / pageWidth * 100) || 10;
            const height = (geo.height / pageHeight * 100) || 10;

            el.style.cssText = `
                left: ${left}%;
                top: ${top}%;
                width: ${width}%;
                height: ${height}%;
                z-index: ${widget.z_index || 1};
            `;

            switch (widget.type) {
                case 'link':
                    el.title = props.title || props.url || 'Lien';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        if (props.url) window.open(props.url, props.target || '_blank');
                    };
                    break;
                case 'video':
                    el.innerHTML = '<i class="fa-solid fa-play widget-icon"></i>';
                    el.title = 'Voir la vidéo';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        if (props.url) this.openVideoModal(props.url);
                    };
                    break;
                case 'audio':
                    el.innerHTML = '<i class="fa-solid fa-volume-high widget-icon"></i>';
                    el.title = 'Écouter';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        if (props.url) this.playAudio(props.url);
                    };
                    break;
                case 'hotspot':
                    el.title = props.title || 'Zone interactive';
                    if (props.url) {
                        el.onclick = (e) => {
                            e.stopPropagation();
                            window.open(props.url, props.target || '_blank');
                        };
                    }
                    break;
            }

            return el;
        }

        // ====================================================================
        // NAVIGATION
        // ====================================================================
        goToPage(index) {
            if (index < 0 || index >= this.totalPages) return;

            this.currentPage = index;

            if (this.engineType === 'pageflip' && this.engine) {
                // turn.js uses 1-based page numbers
                const book = $('#book');
                book.turn('page', index + 1);
            } else if (this.engineType === 'swiper' && this.engine) {
                this.engine.slideTo(index, 0);
            }

            this.updateUI();
        }

        nextPage() {
            if (this.currentPage >= this.totalPages - 1) return;

            if (this.engineType === 'pageflip' && this.engine) {
                const book = $('#book');
                const currentPage = book.turn('page');
                if (currentPage < this.totalPages) {
                    book.turn('page', currentPage + 1);
                    this.playPageFlipSound();
                }
            } else if (this.engineType === 'swiper' && this.engine) {
                this.engine.slideNext();
            }
        }

        prevPage() {
            if (this.currentPage <= 0) return;

            if (this.engineType === 'pageflip' && this.engine) {
                const book = $('#book');
                const currentPage = book.turn('page');
                if (currentPage > 1) {
                    book.turn('page', currentPage - 1);
                    this.playPageFlipSound();
                }
            } else if (this.engineType === 'swiper' && this.engine) {
                this.engine.slidePrev();
            }
        }

        // ====================================================================
        // ZOOM
        // ====================================================================
        zoomIn() {
            if (this.zoomIndex < this.zoomLevels.length - 1) {
                this.zoomIndex++;
                this.applyZoom();
            }
        }

        zoomOut() {
            if (this.zoomIndex > 0) {
                this.zoomIndex--;
                this.applyZoom();
            }
        }

        resetZoom() {
            this.zoomIndex = 2;
            this.applyZoom();
        }

        applyZoom() {
            this.currentZoom = this.zoomLevels[this.zoomIndex];
            const viewport = document.getElementById('reader-viewport');
            viewport.style.transform = `scale(${this.currentZoom})`;
            viewport.style.transformOrigin = 'center center';

            document.getElementById('zoomLevel').textContent = Math.round(this.currentZoom * 100) + '%';
            document.getElementById('zoomOutBtn').disabled = this.zoomIndex <= 0;
            document.getElementById('zoomInBtn').disabled = this.zoomIndex >= this.zoomLevels.length - 1;
        }

        // ====================================================================
        // UI UPDATES
        // ====================================================================
        updateUI() {
            const percentage = Math.round(((this.currentPage + 1) / this.totalPages) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        updateModeDropdown() {
            const modeConfig = this.modes[this.currentMode];

            // Update button
            document.getElementById('currentModeIcon').className = `fa-solid ${modeConfig.icon} mode-icon`;
            document.getElementById('currentModeLabel').textContent = modeConfig.label;

            // Update options
            document.querySelectorAll('.mode-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.mode === this.currentMode);
            });
        }

        // ====================================================================
        // EVENT LISTENERS
        // ====================================================================
        setupEventListeners() {
            // Mode dropdown
            const dropdown = document.getElementById('modeDropdown');
            const dropdownBtn = document.getElementById('modeDropdownBtn');

            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
            });

            document.addEventListener('click', () => {
                dropdown.classList.remove('open');
            });

            document.querySelectorAll('.mode-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const mode = opt.dataset.mode;
                    this.setMode(mode);
                    dropdown.classList.remove('open');
                });
            });

            // Back Button
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', () => this.goBack());
            }

            // Sound
            const soundBtn = document.getElementById('soundBtn');
            if (soundBtn) {
                soundBtn.addEventListener('click', () => this.toggleMute());
            }

            // Zoom
            document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());

            // Fullscreen
            document.getElementById('fullscreenBtn').addEventListener('click', () => this.toggleFullscreen());
            document.addEventListener('fullscreenchange', () => this.handleFullscreenChange());

            // Navigation buttons - play sound on click
            const prevBtn = document.querySelector('.swiper-button-prev, [data-action="prev"]');
            const nextBtn = document.querySelector('.swiper-button-next, [data-action="next"]');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => this.playPageFlipSound());
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => this.playPageFlipSound());
            }

            // Keyboard
            document.addEventListener('keydown', (e) => this.handleKeyboard(e));

            // Resize
            window.addEventListener('resize', () => {
                if (this.engineType === 'pageflip' && this.engine) {
                    this.engine.updateState();
                }
            });
        }

        handleKeyboard(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    e.preventDefault();
                    this.prevPage();
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                case ' ':
                    e.preventDefault();
                    this.nextPage();
                    break;
                case 'Home':
                    e.preventDefault();
                    this.goToPage(0);
                    break;
                case 'End':
                    e.preventDefault();
                    this.goToPage(this.totalPages - 1);
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    this.zoomIn();
                    break;
                case '-':
                    e.preventDefault();
                    this.zoomOut();
                    break;
                case '0':
                    e.preventDefault();
                    this.resetZoom();
                    break;
                case 'f':
                case 'F':
                    e.preventDefault();
                    this.toggleFullscreen();
                    break;
                case 's':
                case 'S':
                    e.preventDefault();
                    this.toggleMute();
                    break;
            }
        }

        toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(console.error);
            } else {
                document.exitFullscreen();
            }
        }

        goBack() {
            // If opened from editor (preview mode), just close the window
            if (this.isPreviewMode && window.opener) {
                window.close();
                return;
            }

            // Otherwise use history or go to gallery
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = '/gallery';
            }
        }

        // ====================================================================
        // AUDIO - PAGE FLIP SOUND EFFECTS (4 Variants for Variety)
        // ====================================================================
        initAudio() {
            try {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.audioInitialized = true;
                console.log('Audio context initialized');
            } catch (e) {
                console.warn('Web Audio API not supported', e);
                this.audioInitialized = false;
            }
        }

        playPageFlipSound() {
            if (!this.audioInitialized || this.isMuted || !this.audioContext) return;

            try {
                const ctx = this.audioContext;
                const now = ctx.currentTime;
                const duration = 0.4; // 400ms

                // Pick a random variant (changes frequency slightly each time)
                const variants = [
                    { freq1: 4000, freq2: 3200, noiseMul: 0.6 },
                    { freq1: 3800, freq2: 3000, noiseMul: 0.65 },
                    { freq1: 4200, freq2: 3400, noiseMul: 0.55 },
                    { freq1: 3900, freq2: 3100, noiseMul: 0.7 }
                ];
                const variant = variants[Math.floor(Math.random() * variants.length)];

                // Create nodes
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const noise = ctx.createBufferSource();
                
                // Create noise buffer
                const bufferSize = ctx.sampleRate * duration;
                const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * variant.noiseMul;
                }
                noise.buffer = noiseBuffer;

                // Gain nodes - increased levels for better audibility
                const masterGain = ctx.createGain();
                const gainOsc1 = ctx.createGain();
                const gainOsc2 = ctx.createGain();
                const gainNoise = ctx.createGain();

                // Envelope (slower decay for longer presence)
                gainOsc1.gain.setValueAtTime(0.25, now);
                gainOsc1.gain.exponentialRampToValueAtTime(0.01, now + duration);
                
                gainOsc2.gain.setValueAtTime(0.25, now);
                gainOsc2.gain.exponentialRampToValueAtTime(0.01, now + duration);
                
                gainNoise.gain.setValueAtTime(0.3, now);
                gainNoise.gain.exponentialRampToValueAtTime(0.01, now + duration);

                // Master volume at 100%
                masterGain.gain.setValueAtTime(1.0, now);

                // High-pass filter for crispy paper sound
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.setValueAtTime(1500, now);
                filter.Q.setValueAtTime(1.5, now);

                // Connect graph: oscillators/noise -> gains -> filter -> master -> destination
                osc1.connect(gainOsc1);
                osc2.connect(gainOsc2);
                noise.connect(gainNoise);

                gainOsc1.connect(filter);
                gainOsc2.connect(filter);
                gainNoise.connect(filter);

                filter.connect(masterGain);
                masterGain.connect(ctx.destination);

                // Set frequencies (will sweep down during duration)
                osc1.frequency.setValueAtTime(variant.freq1, now);
                osc1.frequency.exponentialRampToValueAtTime(2000, now + duration);

                osc2.frequency.setValueAtTime(variant.freq2, now);
                osc2.frequency.exponentialRampToValueAtTime(1600, now + duration);

                // Play
                osc1.start(now);
                osc2.start(now);
                noise.start(now);

                // Stop
                osc1.stop(now + duration);
                osc2.stop(now + duration);
                noise.stop(now + duration);

                console.log('Page flip sound played ✓');

            } catch (error) {
                console.error('Page flip sound error:', error);
            }
        }

        toggleMute() {
            this.isMuted = !this.isMuted;
            const soundBtn = document.getElementById('soundBtn');
            const icon = soundBtn.querySelector('i');

            if (this.isMuted) {
                icon.className = 'fa-solid fa-volume-xmark';
                soundBtn.style.opacity = '0.5';
            } else {
                icon.className = 'fa-solid fa-volume-high';
                soundBtn.style.opacity = '1';
            }
        }

        handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement;
            document.body.classList.toggle('fullscreen', isFullscreen);

            const icon = document.querySelector('#fullscreenBtn i');
            icon.className = isFullscreen ? 'fa-solid fa-compress' : 'fa-solid fa-expand';

            if (this.engineType === 'pageflip' && this.engine) {
                setTimeout(() => this.engine.updateState(), 100);
            }
        }

        // ====================================================================
        // MEDIA HELPERS
        // ====================================================================
        openVideoModal(url) {
            let embedUrl = url;
            const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
            if (ytMatch) embedUrl = `https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1`;

            const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) embedUrl = `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1`;

            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="position:relative;width:80vw;max-width:900px;aspect-ratio:16/9;">
                    <iframe src="${embedUrl}" style="width:100%;height:100%;border:none;" allowfullscreen allow="autoplay"></iframe>
                    <button onclick="this.parentElement.parentElement.remove()" style="position:absolute;top:-40px;right:0;background:none;border:none;color:white;font-size:24px;cursor:pointer;">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        playAudio(url) {
            if (this.currentAudio) {
                this.currentAudio.pause();
                this.currentAudio = null;
            }
            this.currentAudio = new Audio(url);
            this.currentAudio.play().catch(console.error);
        }
    }

    // ========================================================================
    // INITIALIZE
    // ========================================================================
    const reader = new ReaderManager();
    document.addEventListener('DOMContentLoaded', () => reader.init());
    </script>

</body>
</html>
