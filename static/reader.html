<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur - OpenFlip</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- StPageFlip -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <!-- Swiper.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Howler.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-image: none;
        }

        .bg-layer {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-color: #0f172a;
            pointer-events: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', system-ui, sans-serif;
            background: transparent;
            overflow: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 24px;
            z-index: 100;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4f46e5 0%, #4f46e5 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .header-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
            text-align: center;
            max-width: 600px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 20px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }

        .container {
            position: absolute;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 80px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            background: transparent;
            z-index: 10;
        }

        #reader-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pageflip-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        #book {
            background: transparent;
            z-index: 20;
        }

        .stf__wrapper {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
        }

        .my-page {
            background: white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .my-page img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
            pointer-events: none;
        }

        .swiper-container {
            width: 100%;
            height: 100%;
        }

        .swiper {
            width: 100%;
            height: 100%;
        }

        .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }

        .swiper-slide img {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .swiper-pagination-bullet {
            background: white;
            opacity: 0.5;
        }

        .swiper-pagination-bullet-active {
            background: #4f46e5;
            opacity: 1;
        }

        #loading {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #e2e8f0;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        #loading p {
            margin-top: 16px;
            color: #64748b;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #error {
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            text-align: center;
            padding: 20px;
        }

        #error.show { display: flex; }
        #error i { color: #ef4444; font-size: 64px; margin-bottom: 16px; }
        #error h2 { font-size: 24px; color: #1e293b; margin-bottom: 8px; }
        #error p { color: #64748b; margin-bottom: 24px; }
        #error a {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
        }

        .control-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .control-btn {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .control-btn:hover:not(:disabled) {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .control-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
        }

        .mode-dropdown {
            position: relative;
        }

        .mode-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .mode-dropdown-btn:hover {
            background: rgba(79, 70, 229, 0.5);
            border-color: #4f46e5;
        }

        .mode-dropdown-btn i.mode-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        .mode-dropdown-btn i.chevron {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .mode-dropdown.open .mode-dropdown-btn i.chevron {
            transform: rotate(180deg);
        }

        .mode-dropdown-menu {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 8px;
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }

        .mode-dropdown.open .mode-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s;
        }

        .mode-option:hover {
            background: rgba(79, 70, 229, 0.3);
            color: white;
        }

        .mode-option.active {
            background: #4f46e5;
            color: white;
        }

        .mode-option i {
            width: 18px;
            text-align: center;
            font-size: 14px;
        }

        .mode-option-label {
            flex: 1;
        }

        .mode-option .check {
            opacity: 0;
            font-size: 12px;
        }

        .mode-option.active .check {
            opacity: 1;
        }

        .progress-container {
            width: 120px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .zoom-display {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            min-width: 40px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header-title { display: none; }
            .control-bar {
                flex-wrap: wrap;
                max-width: calc(100vw - 32px);
                padding: 8px 12px;
                gap: 8px;
            }
            .control-btn {
                width: 34px;
                height: 34px;
                font-size: 12px;
            }
            .control-divider { display: none; }
            .mode-dropdown-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            .progress-container { width: 80px; }
        }

        body.fullscreen {
            background: #000;
        }

        body.fullscreen .header {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.fullscreen .control-bar {
            background: rgba(0, 0, 0, 0.7);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <button class="back-btn" id="backBtn" title="Retour">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <a href="/" class="header-logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-book-open"></i>
                </div>
                <span><span style="color: #4f46e5;">Open</span><span>Flip</span></span>
            </a>
        </div>
        <div class="header-title" id="docTitle"></div>
    </header>

    <div id="loading">
        <div class="spinner"></div>
        <p>Chargement du flipbook...</p>
    </div>

    <div id="bg-layer" class="bg-layer"></div>

    <div class="container" id="main-container">
        <div id="reader-viewport"></div>
    </div>

    <div class="control-bar">
        <button class="control-btn" id="prevBtn" title="Page pr√©c√©dente">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <button class="control-btn" id="nextBtn" title="Page suivante">
            <i class="fa-solid fa-chevron-right"></i>
        </button>

        <div class="control-divider"></div>

        <div class="mode-dropdown" id="modeDropdown">
            <button class="mode-dropdown-btn" id="modeDropdownBtn">
                <i class="fa-solid fa-book-open mode-icon" id="currentModeIcon"></i>
                <span id="currentModeLabel">Standard</span>
                <i class="fa-solid fa-chevron-up chevron"></i>
            </button>
            <div class="mode-dropdown-menu" id="modeDropdownMenu">
                <div class="mode-option active" data-mode="standard">
                    <i class="fa-solid fa-book-open"></i>
                    <span class="mode-option-label">Standard</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="coverflow">
                    <i class="fa-solid fa-layer-group"></i>
                    <span class="mode-option-label">Coverflow</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="cards">
                    <i class="fa-solid fa-clone"></i>
                    <span class="mode-option-label">Cartes</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="cube">
                    <i class="fa-solid fa-cube"></i>
                    <span class="mode-option-label">Cube</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
                <div class="mode-option" data-mode="fade">
                    <i class="fa-solid fa-images"></i>
                    <span class="mode-option-label">Slide / Fondu</span>
                    <i class="fa-solid fa-check check"></i>
                </div>
            </div>
        </div>

        <div class="control-divider"></div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="control-divider"></div>

        <button class="control-btn" id="zoomOutBtn" title="Zoom arri√®re">
            <i class="fa-solid fa-minus"></i>
        </button>
        <span class="zoom-display" id="zoomLevel">100%</span>
        <button class="control-btn" id="zoomInBtn" title="Zoom avant">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div class="control-divider"></div>

        <button class="control-btn" id="soundBtn" title="Son">
            <i class="fa-solid fa-volume-high"></i>
        </button>

        <div class="control-divider"></div>

        <button class="control-btn" id="fullscreenBtn" title="Plein √©cran">
            <i class="fa-solid fa-expand"></i>
        </button>
    </div>

    <div id="error">
        <i class="fa-solid fa-circle-exclamation"></i>
        <h2>Document introuvable</h2>
        <p>Ce document n'existe pas ou a √©t√© supprim√©.</p>
        <a href="/upload">Cr√©er un flipbook</a>
    </div>

    <script>
    class ReaderManager {
        constructor() {
            this.engine = null;
            this.engineType = null;
            this.currentMode = 'standard';
            this.currentPage = 0;
            this.totalPages = 0;
            this.docId = null;
            this.pagesData = [];

            this.zoomLevels = [0.5, 0.75, 1, 1.25, 1.5, 2];
            this.zoomIndex = 2;
            this.currentZoom = 1;

            this.flipSounds = [];
            this.isMuted = false;
            this.soundEnabled = true;
            this.audioInitialized = false;

            this.modes = {
                standard: { engine: 'pageflip', icon: 'fa-book-open', label: 'Standard' },
                coverflow: { engine: 'swiper', effect: 'coverflow', icon: 'fa-layer-group', label: 'Coverflow' },
                cards: { engine: 'swiper', effect: 'cards', icon: 'fa-clone', label: 'Cartes' },
                cube: { engine: 'swiper', effect: 'cube', icon: 'fa-cube', label: 'Cube' },
                fade: { engine: 'swiper', effect: 'fade', icon: 'fa-images', label: 'Slide / Fondu' }
            };

            this.swiperEffects = {
                coverflow: {
                    effect: 'coverflow',
                    grabCursor: true,
                    slidesPerView: 1,
                    coverflowEffect: { rotate: 50, stretch: 0, depth: 100, modifier: 1, slideShadows: false }
                },
                cards: {
                    effect: 'cards',
                    grabCursor: true,
                    cardsEffect: { slideShadows: false, perSlideOffset: 8, perSlideRotate: 2 }
                },
                cube: {
                    effect: 'cube',
                    grabCursor: true,
                    cubeEffect: { shadow: false, slideShadows: false, shadowOffset: 20, shadowScale: 0.94 }
                },
                fade: {
                    effect: 'fade',
                    fadeEffect: { crossFade: true }
                }
            };
        }

        async init() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let docId = urlParams.get('id');

                if (!docId) {
                    const pathParts = window.location.pathname.split('/').filter(p => p);
                    docId = pathParts[pathParts.length - 1];
                    if (docId) docId = docId.split('?')[0];
                }

                this.docId = docId;
                if (!this.docId) throw new Error('ID du document manquant');

                console.log(`[Reader] Loading: ${this.docId}`);

                let doc = null;

                try {
                    const storedData = localStorage.getItem(`preview_${this.docId}`);
                    if (storedData) {
                        doc = JSON.parse(storedData);
                        localStorage.removeItem(`preview_${this.docId}`);
                    }
                } catch (e) {}

                if (!doc) {
                    const res = await fetch(`/api/reader/${this.docId}`);
                    if (!res.ok) throw new Error('Document introuvable');
                    doc = await res.json();
                }

                this.totalPages = doc.page_count || doc.pages?.length || 0;
                this.pagesData = doc.pages || [];
                this.styleConfig = doc.style || {};
                this.isPreviewMode = !!window.opener;

                if (this.totalPages === 0) throw new Error('Aucune page');

                const title = doc.title || 'Flipbook';
                document.title = `${title} - OpenFlip`;
                document.getElementById('docTitle').textContent = title;

                let initialMode = this.styleConfig.viewMode || this.styleConfig.view_mode || this.styleConfig.mode || 'standard';

                if (initialMode === 'standard') await this.waitForStPageFlip();

                await this.setMode(initialMode);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-container').style.display = 'flex';

                this.applyStyleConfig();
                this.setupEventListeners();
                this.initAudio();
                this.updateUI();

                console.log('[Reader] ‚úì Ready');

            } catch (error) {
                console.error('[Reader] Error:', error);
                this.showError(error.message);
            }
        }

        waitForStPageFlip() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('StPageFlip timeout')), 10000);
                const check = () => {
                    if (typeof St !== 'undefined' && St.PageFlip) {
                        clearTimeout(timeout);
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        showError(message) {
            document.getElementById('loading').classList.add('hidden');
            const errorEl = document.getElementById('error');
            const errorMsg = errorEl.querySelector('p');
            if (errorMsg) errorMsg.textContent = message;
            errorEl.classList.add('show');
        }

        applyStyleConfig() {
            const style = this.styleConfig || {};
            const bgLayer = document.getElementById('bg-layer');

            const bgColor = style.backgroundColor || style.background_color || style.bgColor || '#0f172a';
            if (bgLayer) bgLayer.style.backgroundColor = bgColor;

            const bgImage = style.backgroundImage || style.background_image || style.bgImage;
            if (bgImage && bgLayer) {
                document.documentElement.style.setProperty('--bg-image', `url(${bgImage})`);
                bgLayer.style.backgroundImage = `url(${bgImage})`;
            }

            this.soundEnabled = style.sound !== false && style.soundEnabled !== false;
            if (!this.soundEnabled) {
                document.getElementById('soundBtn').style.display = 'none';
                this.isMuted = true;
            }
        }

        async setMode(modeName) {
            const modeConfig = this.modes[modeName];
            if (!modeConfig) return;

            const savedPage = this.currentPage;
            this.destroyEngine();

            const viewport = document.getElementById('reader-viewport');
            viewport.innerHTML = '';

            this.currentMode = modeName;
            this.engineType = modeConfig.engine;

            if (modeConfig.engine === 'pageflip') {
                await this.buildPageFlip(viewport);
            } else {
                await this.buildSwiper(viewport, modeConfig.effect);
            }

            this.goToPage(savedPage);
            this.updateModeDropdown();
            this.updateUI();
        }

        destroyEngine() {
            if (!this.engine) return;
            try {
                if (this.engineType === 'pageflip') this.engine.destroy();
                else if (this.engineType === 'swiper') this.engine.destroy(true, true);
            } catch (e) {}
            this.engine = null;
        }

        async buildPageFlip(container) {
            console.log('[Reader] Building StPageFlip...');
            
            const wrapper = document.createElement('div');
            wrapper.className = 'pageflip-container';

            const book = document.createElement('div');
            book.id = 'book';
            wrapper.appendChild(book);
            container.appendChild(wrapper);

            // Calculate optimal dimensions
            const viewportHeight = window.innerHeight - 64 - 150;
            const viewportWidth = window.innerWidth - 200;

            const pageAspectRatio = 595 / 842; // A4
            
            let bookHeight = Math.min(viewportHeight, 1000);
            let bookWidth = bookHeight * pageAspectRatio * 2;
            
            if (bookWidth > viewportWidth) {
                bookWidth = viewportWidth;
                bookHeight = bookWidth / (pageAspectRatio * 2);
            }

            bookWidth = Math.floor(bookWidth);
            bookHeight = Math.floor(bookHeight);
            const pageWidth = Math.floor(bookWidth / 2);

            console.log(`[Reader] Size: ${bookWidth}x${bookHeight} (page: ${pageWidth}x${bookHeight})`);

            try {
                this.engine = new St.PageFlip(book, {
                    width: pageWidth,
                    height: bookHeight,
                    size: 'fixed',
                    minWidth: 315,
                    maxWidth: 2000,
                    minHeight: 400,
                    maxHeight: 1600,
                    showCover: false,
                    mobileScrollSupport: false,
                    swipeDistance: 30,
                    clickEventForward: true,
                    usePortrait: false,
                    startPage: 0,
                    drawShadow: true,
                    flippingTime: 600,
                    useMouseEvents: true,
                    autoSize: false,
                    maxShadowOpacity: 0.5,
                    showPageCorners: true,
                    disableFlipByClick: false
                });

                // Load images into PageFlip
                const imageUrls = this.pagesData.map(pageData => 
                    pageData.image_url || pageData.image_path || `/pages/${this.docId}/page_${pageData.page_num || (this.pagesData.indexOf(pageData) + 1)}.webp`
                );
                this.engine.loadFromImages(imageUrls);

                // Add widgets after a short delay to ensure PageFlip is ready
                setTimeout(() => {
                    this.addWidgetsOverlay();
                }, 100);

                this.engine.on('flip', (e) => {
                    this.currentPage = e.data;
                    this.addWidgetsOverlay();
                    this.playPageFlipSound();
                    this.updateUI();
                });

                console.log('[Reader] ‚úì StPageFlip ready');

            } catch (error) {
                console.error('[Reader] StPageFlip error:', error);
                throw error;
            }
        }

        addWidgetsOverlay() {
            // Remove existing widgets overlay
            const oldOverlay = document.querySelector('.book-widgets-overlay');
            if (oldOverlay) oldOverlay.remove();

            // Get current page data
            const pageData = this.pagesData[this.currentPage];
            console.log('[Widgets] Page:', this.currentPage, 'Data:', pageData);
            if (!pageData || !pageData.widgets || pageData.widgets.length === 0) {
                console.log('[Widgets] No widgets for this page');
                return;
            }

            console.log('[Widgets] Found', pageData.widgets.length, 'widgets');

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'book-widgets-overlay';
            overlay.style.cssText = `
                position: fixed;
                pointer-events: none;
                z-index: 30;
            `;

            let pageWidth, pageHeight, overlayLeft, overlayTop;

            if (this.engineType === 'pageflip') {
                // Get book position and dimensions for PageFlip
                const book = document.getElementById('book');
                const wrapper = document.querySelector('.pageflip-container');
                console.log('[Widgets] Book:', book, 'Wrapper:', wrapper);
                if (!book || !wrapper) {
                    console.log('[Widgets] No book or wrapper found');
                    return;
                }
                
                const bookRect = book.getBoundingClientRect();
                console.log('[Widgets] BookRect:', bookRect);
                
                // Each page is half the width
                pageWidth = bookRect.width / 2;
                pageHeight = bookRect.height;
                overlayLeft = bookRect.left;
                overlayTop = bookRect.top;
                
                // Position overlay to match the book
                overlay.style.left = bookRect.left + 'px';
                overlay.style.top = bookRect.top + 'px';
                overlay.style.width = bookRect.width + 'px';
                overlay.style.height = bookRect.height + 'px';
            } else if (this.engineType === 'swiper') {
                // Get active slide position and dimensions for Swiper
                const activeSlide = document.querySelector('.swiper-slide-active img');
                const swiperContainer = document.querySelector('.swiper-container');
                console.log('[Widgets] Active slide:', activeSlide, 'Container:', swiperContainer);
                if (!activeSlide || !swiperContainer) {
                    console.log('[Widgets] No active slide or container found');
                    return;
                }
                
                const slideRect = activeSlide.getBoundingClientRect();
                const containerRect = swiperContainer.getBoundingClientRect();
                console.log('[Widgets] SlideRect:', slideRect);
                
                pageWidth = slideRect.width;
                pageHeight = slideRect.height;
                overlayLeft = slideRect.left;
                overlayTop = slideRect.top;
                
                // Position overlay to match the slide
                overlay.style.left = slideRect.left + 'px';
                overlay.style.top = slideRect.top + 'px';
                overlay.style.width = slideRect.width + 'px';
                overlay.style.height = slideRect.height + 'px';
            } else {
                return;
            }

            pageData.widgets.forEach((widget, idx) => {
                const widgetEl = document.createElement('div');
                widgetEl.className = 'widget-overlay';
                widgetEl.style.cssText = `
                    position: absolute;
                    pointer-events: auto;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 500;
                    color: white;
                    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                    overflow: hidden;
                    text-align: center;
                    padding: 4px 6px;
                    border-radius: 6px;
                    backdrop-filter: blur(2px);
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    opacity: 0.65;
                `;
                
                // R√©cup√©rer la g√©om√©trie et les props du widget
                const geometry = widget.geometry || {};
                const props = widget.props || {};
                
                const x = geometry.x || 0;
                const y = geometry.y || 0;
                const w = geometry.width || 100;
                const h = geometry.height || 100;
                
                // Calculer les positions en pixels bas√©es sur les coordonn√©es absolues
                const left = (x / 595 * pageWidth);
                const top = (y / 842 * pageHeight);
                const width = (w / 595 * pageWidth);
                const height = (h / 842 * pageHeight);

                console.log('[Widget', idx + ']', widget.type, 'Props:', props, 'Geom:', geometry, '- Pos:', left, top, 'Size:', width, height);

                widgetEl.style.left = left + 'px';
                widgetEl.style.top = top + 'px';
                widgetEl.style.width = width + 'px';
                widgetEl.style.height = height + 'px';
                
                // R√©cup√©rer le texte du widget depuis les props
                const widgetText = props.text || props.title || props.label || '';
                const widgetUrl = props.url || '';
                
                // Ajouter effet hover
                widgetEl.onmouseover = () => {
                    widgetEl.style.opacity = '1';
                    widgetEl.style.transform = 'scale(1.08)';
                    widgetEl.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
                };
                widgetEl.onmouseout = () => {
                    widgetEl.style.opacity = '0.65';
                    widgetEl.style.transform = 'scale(1)';
                    widgetEl.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                };
                
                // Couleurs plus subtiles avec opacit√© r√©duite
                if (widget.type === 'link') {
                    widgetEl.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.5) 0%, rgba(37, 99, 235, 0.5) 100%)';
                    widgetEl.style.borderLeft = '3px solid rgba(59, 130, 246, 0.7)';
                    widgetEl.innerHTML = `<a href="${widgetUrl}" target="${props.target || '_blank'}" style="display: flex; width: 100%; height: 100%; align-items: center; justify-content: center; text-decoration: none; color: white; font-size: 10px; font-weight: 500; gap: 3px; white-space: nowrap;"><span style="font-size: 12px;">üîó</span> <span>${widgetText || 'Lien'}</span></a>`;
                } else if (widget.type === 'video') {
                    widgetEl.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.5) 0%, rgba(220, 38, 38, 0.5) 100%)';
                    widgetEl.style.borderLeft = '3px solid rgba(239, 68, 68, 0.7)';
                    widgetEl.innerHTML = `<button onclick="window.open('${widgetUrl}', '_blank')" style="width: 100%; height: 100%; cursor: pointer; border: none; background: transparent; color: white; font-weight: 500; font-size: 10px; display: flex; align-items: center; justify-content: center; gap: 3px; white-space: nowrap;"><span style="font-size: 12px;">‚ñ∂Ô∏è</span> <span>${widgetText || 'Vid√©o'}</span></button>`;
                } else if (widget.type === 'image') {
                    widgetEl.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.5) 0%, rgba(22, 163, 74, 0.5) 100%)';
                    widgetEl.style.borderLeft = '3px solid rgba(34, 197, 94, 0.7)';
                    widgetEl.innerHTML = `<img src="${widgetUrl}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer; display: block; border-radius: 3px;" onclick="window.open('${widgetUrl}', '_blank')" title="${widgetText}" />`;
                } else if (widget.type === 'iframe') {
                    widgetEl.style.background = 'linear-gradient(135deg, rgba(249, 115, 22, 0.5) 0%, rgba(234, 88, 12, 0.5) 100%)';
                    widgetEl.style.borderLeft = '3px solid rgba(249, 115, 22, 0.7)';
                    widgetEl.innerHTML = `<iframe src="${widgetUrl}" style="width: 100%; height: 100%; border: none; border-radius: 3px;"></iframe>`;
                } else if (widget.type === 'audio') {
                    widgetEl.style.background = 'linear-gradient(135deg, rgba(168, 85, 247, 0.5) 0%, rgba(147, 51, 234, 0.5) 100%)';
                    widgetEl.style.borderLeft = '3px solid rgba(168, 85, 247, 0.7)';
                    widgetEl.innerHTML = `<button onclick="new Howler.Howl({src: '${widgetUrl}'}).play()" style="width: 100%; height: 100%; cursor: pointer; border: none; background: transparent; color: white; font-weight: 500; font-size: 10px; display: flex; align-items: center; justify-content: center; gap: 3px; white-space: nowrap;"><span style="font-size: 12px;">üîä</span> <span>${widgetText || 'Audio'}</span></button>`;
                } else if (widget.type === 'hotspot') {
                    widgetEl.style.background = 'linear-gradient(135deg, rgba(236, 72, 153, 0.5) 0%, rgba(219, 39, 119, 0.5) 100%)';
                    widgetEl.style.borderLeft = '3px solid rgba(236, 72, 153, 0.7)';
                    widgetEl.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; font-weight: 500; gap: 3px; white-space: nowrap;" title="${widgetText}"><span style="font-size: 12px;">üìç</span> <span>${widgetText || 'Hotspot'}</span></div>`;
                }
                
                overlay.appendChild(widgetEl);
            });

            document.body.appendChild(overlay);
            console.log('[Widgets] Overlay added to body');
        }

        async buildSwiper(container, effect) {
            const swiperContainer = document.createElement('div');
            swiperContainer.className = 'swiper-container';

            const swiper = document.createElement('div');
            swiper.className = 'swiper';

            const wrapper = document.createElement('div');
            wrapper.className = 'swiper-wrapper';

            for (let i = 0; i < this.totalPages; i++) {
                const pageData = this.pagesData[i] || {};
                const pageNum = pageData.page_num || (i + 1);

                const slide = document.createElement('div');
                slide.className = 'swiper-slide';

                const img = document.createElement('img');
                img.src = pageData.image_url || pageData.image_path || `/pages/${this.docId}/page_${pageNum}.webp`;
                img.alt = `Page ${pageNum}`;
                img.loading = pageNum <= 3 ? 'eager' : 'lazy';
                img.draggable = false;
                slide.appendChild(img);

                wrapper.appendChild(slide);
            }

            swiper.appendChild(wrapper);

            const pagination = document.createElement('div');
            pagination.className = 'swiper-pagination';
            swiper.appendChild(pagination);

            swiperContainer.appendChild(swiper);
            container.appendChild(swiperContainer);

            const effectConfig = this.swiperEffects[effect] || {};

            this.engine = new Swiper('.swiper', {
                ...effectConfig,
                speed: 800,
                keyboard: { enabled: true },
                slidesPerView: 1,
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                    dynamicBullets: true
                },
                on: {
                    slideChange: () => {
                        this.currentPage = this.engine.activeIndex;
                        this.addWidgetsOverlay();
                        this.updateUI();
                    }
                }
            });

            // Add widgets for initial slide
            setTimeout(() => {
                this.addWidgetsOverlay();
            }, 100);
        }

        goToPage(index) {
            if (index < 0 || index >= this.totalPages) return;
            this.currentPage = index;

            if (this.engineType === 'pageflip' && this.engine) {
                this.engine.turnToPage(index);
            } else if (this.engineType === 'swiper' && this.engine) {
                this.engine.slideTo(index, 0);
            }

            this.updateUI();
        }

        nextPage() {
            if (this.engineType === 'pageflip' && this.engine) {
                this.engine.flipNext();
            } else if (this.engineType === 'swiper' && this.engine) {
                this.engine.slideNext();
            }
        }

        prevPage() {
            if (this.engineType === 'pageflip' && this.engine) {
                this.engine.flipPrev();
            } else if (this.engineType === 'swiper' && this.engine) {
                this.engine.slidePrev();
            }
        }

        zoomIn() {
            if (this.zoomIndex < this.zoomLevels.length - 1) {
                this.zoomIndex++;
                this.applyZoom();
            }
        }

        zoomOut() {
            if (this.zoomIndex > 0) {
                this.zoomIndex--;
                this.applyZoom();
            }
        }

        applyZoom() {
            this.currentZoom = this.zoomLevels[this.zoomIndex];
            const viewport = document.getElementById('reader-viewport');
            viewport.style.transform = `scale(${this.currentZoom})`;

            document.getElementById('zoomLevel').textContent = Math.round(this.currentZoom * 100) + '%';
            document.getElementById('zoomOutBtn').disabled = this.zoomIndex <= 0;
            document.getElementById('zoomInBtn').disabled = this.zoomIndex >= this.zoomLevels.length - 1;
        }

        updateUI() {
            const percentage = Math.round(((this.currentPage + 1) / this.totalPages) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';

            document.getElementById('prevBtn').disabled = this.currentPage <= 0;
            document.getElementById('nextBtn').disabled = this.currentPage >= this.totalPages - 1;
        }

        updateModeDropdown() {
            const modeConfig = this.modes[this.currentMode];
            document.getElementById('currentModeIcon').className = `fa-solid ${modeConfig.icon} mode-icon`;
            document.getElementById('currentModeLabel').textContent = modeConfig.label;

            document.querySelectorAll('.mode-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.mode === this.currentMode);
            });
        }

        setupEventListeners() {
            const dropdown = document.getElementById('modeDropdown');
            const dropdownBtn = document.getElementById('modeDropdownBtn');

            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
            });

            document.addEventListener('click', () => dropdown.classList.remove('open'));

            document.querySelectorAll('.mode-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setMode(opt.dataset.mode);
                    dropdown.classList.remove('open');
                });
            });

            document.getElementById('backBtn').addEventListener('click', () => this.goBack());
            document.getElementById('soundBtn').addEventListener('click', () => this.toggleMute());
            document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
            document.getElementById('prevBtn').addEventListener('click', () => this.prevPage());
            document.getElementById('nextBtn').addEventListener('click', () => this.nextPage());
            document.getElementById('fullscreenBtn').addEventListener('click', () => this.toggleFullscreen());
            document.addEventListener('fullscreenchange', () => this.handleFullscreenChange());
            document.addEventListener('keydown', (e) => this.handleKeyboard(e));

            window.addEventListener('resize', () => {
                clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => {
                    if (this.engineType === 'pageflip' && this.engine) {
                        this.engine.updateState();
                    }
                }, 200);
            });
        }

        handleKeyboard(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    e.preventDefault();
                    this.prevPage();
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                case ' ':
                    e.preventDefault();
                    this.nextPage();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    this.zoomIn();
                    break;
                case '-':
                    e.preventDefault();
                    this.zoomOut();
                    break;
                case 'f':
                case 'F':
                    e.preventDefault();
                    this.toggleFullscreen();
                    break;
                case 's':
                case 'S':
                    e.preventDefault();
                    this.toggleMute();
                    break;
            }
        }

        toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement;
            document.body.classList.toggle('fullscreen', isFullscreen);

            const icon = document.querySelector('#fullscreenBtn i');
            icon.className = isFullscreen ? 'fa-solid fa-compress' : 'fa-solid fa-expand';

            if (this.engineType === 'pageflip' && this.engine) {
                setTimeout(() => this.engine.updateState(), 100);
            }
        }

        goBack() {
            if (this.isPreviewMode && window.opener) {
                window.close();
            } else if (history.length > 1) {
                history.back();
            } else {
                window.location.href = '/gallery';
            }
        }

        initAudio() {
            if (!this.soundEnabled || typeof Howl === 'undefined') {
                this.audioInitialized = false;
                return;
            }

            try {
                this.flipSounds = ['/static/sounds/flip-1.mp3', '/static/sounds/flip-4.mp3'].map(src => 
                    new Howl({ src: [src], volume: 0.6, preload: true })
                );
                this.audioInitialized = true;
            } catch (error) {
                this.audioInitialized = false;
            }
        }

        playPageFlipSound() {
            if (!this.soundEnabled || this.isMuted || !this.audioInitialized || this.flipSounds.length === 0) return;

            try {
                const sound = this.flipSounds[Math.floor(Math.random() * this.flipSounds.length)];
                if (sound && sound.state() === 'loaded') sound.play();
            } catch (error) {}
        }

        toggleMute() {
            if (!this.soundEnabled) return;

            this.isMuted = !this.isMuted;
            const soundBtn = document.getElementById('soundBtn');
            const icon = soundBtn?.querySelector('i');

            if (icon) {
                icon.className = this.isMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
                soundBtn.style.opacity = this.isMuted ? '0.5' : '1';
                Howler.mute(this.isMuted);
            }
        }
    }

    const reader = new ReaderManager();
    document.addEventListener('DOMContentLoaded', () => reader.init());
    </script>

</body>
</html>